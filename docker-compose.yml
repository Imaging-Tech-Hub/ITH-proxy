version: '3.8'

services:
  proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ith-proxy
    restart: unless-stopped

    ports:
      # Django HTTP API
      - "8080:8080"
      # DICOM SCP Server
      - "${DICOM_PORT:-11112}:${DICOM_PORT:-11112}"

    volumes:
      # Persist data directory (database, DICOM files, logs, archives)
      - ./data:/app/data
      # Optional: Mount .env file
      - ./.env:/app/.env:ro

    environment:
      # Django Settings
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY:-django-insecure-change-this-in-production}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}

      # Database Configuration - SQLite
      - DATABASE_ENGINE=sqlite
      - DATABASE_PATH=/app/data/database/db.sqlite3

      # DICOM Configuration
      - DICOM_AE_TITLE=${DICOM_AE_TITLE:-DICOMRCV}
      - DICOM_PORT=${DICOM_PORT:-11112}
      - DICOM_BIND_ADDRESS=${DICOM_BIND_ADDRESS:-0.0.0.0}
      - DICOM_STORAGE_DIR=${DICOM_STORAGE_DIR:-/app/data}
      - DICOM_LOG_DIR=${DICOM_LOG_DIR:-/app/data/logs}
      - DICOM_MAX_PDU_SIZE=${DICOM_MAX_PDU_SIZE:-16384}
      - DICOM_ACSE_TIMEOUT=${DICOM_ACSE_TIMEOUT:-30}
      - DICOM_DIMSE_TIMEOUT=${DICOM_DIMSE_TIMEOUT:-60}
      - DICOM_NETWORK_TIMEOUT=${DICOM_NETWORK_TIMEOUT:-60}
      - DICOM_MAX_ASSOCIATIONS=${DICOM_MAX_ASSOCIATIONS:-50}
      - DICOM_STUDY_TIMEOUT=${DICOM_STUDY_TIMEOUT:-60}
      - DICOM_LOG_LEVEL=${DICOM_LOG_LEVEL:-INFO}
      - DICOM_ANONYMIZE_PATIENTS=${DICOM_ANONYMIZE_PATIENTS:-True}
      - DICOM_AUTO_START=${DICOM_AUTO_START:-True}

      # ITH Backend Integration
      - ITH_URL=${ITH_URL:-http://host.docker.internal:8000}
      - ITH_TOKEN=${ITH_TOKEN}
      - PROXY_VERSION=${PROXY_VERSION:-1.0.0}

      # Archive & Upload
      - ARCHIVE_DIR=${ARCHIVE_DIR:-/app/data/archives}
      - UPLOAD_MAX_RETRIES=${UPLOAD_MAX_RETRIES:-3}
      - UPLOAD_RETRY_DELAY=${UPLOAD_RETRY_DELAY:-5}
      - CLEANUP_AFTER_UPLOAD=${CLEANUP_AFTER_UPLOAD:-True}

      # Locale
      - TIME_ZONE=${TIME_ZONE:-UTC}
      - LANGUAGE_CODE=${LANGUAGE_CODE:-en-us}

    networks:
      - ith-network

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/api/health/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  ith-network:
    driver: bridge
